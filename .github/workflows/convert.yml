on:
  push:
    branches: [ 'main' ]
  pull_request:
    branches: [ 'main' ]
    
jobs:
  build:
    permissions: write-all
    name: Build and validate token sheets
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sheets
        uses: actions/checkout@v4

      - name: Prepare build env
        run: mkdir built

      - name: Run build script
        shell: python
        run: |
          import os
          import sys
          
          module_path = os.path.abspath(os.getcwd())
          if module_path not in sys.path:
            sys.path.append(module_path)
          
          import json
          import xml.etree.ElementTree as ET
          from scripts.formats import *
          
          with open("8X.xml", encoding="UTF-8") as infile:
            root = ET.fromstring(src := infile.read())
          
            with open("built/8X.xml", "w+", encoding="UTF-8") as outfile:
              validate(root)
              outfile.write(src)
          
            with open("built/8X.json", "w+", encoding="UTF-8") as outfile:
              json.dump(to_json(root), outfile, indent=2, ensure_ascii=False)

      - name: Save to built branch
        uses: s0/git-publish-subdir-action@develop
        env:
          REPO: self
          BRANCH: built
          FOLDER: built
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MESSAGE: "Generate build from {sha}: {msg}"
